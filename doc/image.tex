\index{KIWI images!creating|(}
\chapter{Creating Operating System Images}
\label{chapter:cropsysimg}
\minitoc

The creation of operating system images is based on image description
trees. An image description contains all the files in a directory that
are required to generate an image using the Perl-based image builder
\textbf{kiwi.pl}. The directory to which the description files are
written must contain a VERSION file with a three-part version number of
the format:

\begin{Command}{9cm}
\textbf{Major}.\textbf{Minor}.\textbf{Release}
\end{Command}

\index{KIWI images!version numbers}
\begin{itemize}
\item For smaller image modifications that do not add or remove any
      new packages, only the release number is incremented.
      The \textbf{config.xml} file remains unchanged.
\item For image changes that involve the addition or removal of packages
      the minor number is incremented and the release number is reset.
\item For image changes that change the size of the image file
      the major number is incremented.
\end{itemize}

\section{Structure of the Image Description Tree}
\index{KIWI images!tree structure}
\label{imagetree}
\begin{itemize}

\item \textbf{\underline{VERSION}}\\
      This file contains the version number of the image description tree,
      for example, 1.1.2.
\item \textbf{\underline{root}}\\
      Subdirectory that contains special files, directories, and scripts for
      adapting the image environment \textbf{after} the installation of all the
      image packages. The entire directory is copied into the root of the
      image tree using \textit{cp -a}.
\item \textbf{\underline{config}}\\
      Optional Subdirectory that contains Bash scripts that are called
      after the installation of all the image packages, primarily in order
      to remove the parts of a package that are not needed for the operating
      system. The name of the Bash script must resemble the package name
      listed in the config.xml
\item \textbf{\underline{config.sh}}\\
      Optional configuration script while creating the physical extend. This
      script is called at the end of the installation but \textbf{before}
      the package scripts have run. It is designed to configure the image
      system, such as the activation or deactivation of certain services
      (insserv). The call is not made until after the switch to the image
      has been made with \textbf{chroot}.
\item \textbf{\underline{images.sh}}\\
      Optional configuration script while creating the logical extend.
      This script is called at the beginning of the image creation process.
      It is designed to clean-up the image system. Affected are all the
      programs and files only needed while the physical extend exists.
\item \textbf{\underline{config.xml}}\\
      Configuration file that indicates the image type, base name,
      options, and which packages make up the image. The structure of the
	  file corresponds to the format

      \begin{Command}{13cm}
      <image name="Name">\\
      \hspace*{1cm}<preferences>\\
      \hspace*{2cm}<type>Type</type>\\
      \hspace*{2cm}<size unit="Unit">Size</size>\\
      \hspace*{2cm}<compressed>Yes/No</compressed>\\
      \hspace*{1cm}</preferences>\\
      \hspace*{1cm}<users group="groupname">\\
      \hspace*{2cm}<user name="user" pwd="word" home="dir"/>\\
      \hspace*{1cm}</users>\\
      \hspace*{1cm}<drivers type="Type">\\
      \hspace*{2cm}<file name="Filename"/>\\
      \hspace*{1cm}</drivers>\\
      \hspace*{1cm}<repository type="Type">\\
      \hspace*{2cm}<source path="URL"/>\\
      \hspace*{1cm}</repository>\\
      \hspace*{1cm}<packages type="Type">\\
      \hspace*{2cm}<package name="Packagename"/>\\
      \hspace*{2cm}<opensusePattern name="Patternname"/>\\
      \hspace*{1cm}</packages>\\
      </image>
	  \end{Command}

      The config.xml file contains four major parts embedded into a
      XML image tag. The image tag contains the attrubute \textbf{name}
      to indicate the base name of the image. It is automatically expanded
      using the version number and the date. The version number is
      extracted from the directory in which the description files for
      this image are located.

      \begin{enumerate}
          \item The \textbf{preferences} tag contains information needed to
          create the logical extend. For this tag the following subtags
          are defined:
          \begin{itemize}
              \item \textbf{size}\\
                    Image size as a number whereas the attribute
                    \textbf{unit} defines the scale unit \textbf{M} or
                    \textbf{G} standing for Megabyte or Gigabyte.
                    \underline{Note:}
                    \textit{kiwi} supports the feature extending the image size
                    automatically to a calculated size, if the specified
                    config size value is to small. If the config size value
                    plus the additional size needed to build the image is more
                    than 100MB, \textit{kiwi} will abort with an error message.
                    Furthermore \textit{kiwi} will not reduce the image size
                    automatically by design, because it must be possible to
                    configure additional space, for example, if custom scripts
                    are run.
              \item \textbf{type}\\
                    The image type of the logical extend: \textbf{ext2},
                    \textbf{ext3}, \textbf{cpio}, \textbf{reiserfs}.
                    Different formats are possible, if necessary.
              \item \textbf{timezone}\\
                    The time zone. The possible time zones are located in the
                    directory \textit{/usr/share/zoneinfo}. For the image
                    itself, only one time zone each is required. For this
                    reason, the relative path to the time zone to use in the
                    image is indicated after the \textbf{timezone} key, for
                    example, \textbf{Europe/Berlin}. kiwi uses this information
                    to extract the corresponding time zone from the timezone
                    package and to store it as \textit{/etc/localtime} in the
                    image.
              \item \textbf{keytable}\\
                    Contains the name of the console keymap to use. The name
                    corresponds to a map file stored below the path
                    \textit{/usr/share/kbd/keymaps}. Furthermore, the variable
                    \textit{KEYTABLE} within the file
                    \textit{/etc/sysconfig/keyboard} will be set according
                    to the keyboard mapping.
          \end{itemize}
          \item The optional \textbf{users} tag contains user information
                used to add users to the image. The attribute \textbf{group}
                specifies the group the user(s) belongs to. If this group
                doesn't exist it will be created. Within \textit{users}
                each user is described in one \textbf{user} tag including the
                attributes \textbf{name, pwd and home} which describes the
                name of the user it password and its home directory.
          \item The optional \textbf{drivers} tag contains driver file names.
                The names are interpreted as general driver name and captured
                if they are contained in the kernel tree. The attribute
                \textbf{type} specifies one of the following driver types:
                \begin{itemize}
                \item \textbf{\underline{netdrivers}}\\
                      Every file is indicated relative to the directory\\
                      \textit{/lib/modules/$<$Version$>$/kernel/drivers/net}
                \item \textbf{\underline{drivers}}\\
                      Every file is indicated relative to the directory\\
                      \textit{/lib/modules/$<$Version$>$/kernel}
                \end{itemize}
          \item The \textbf{repository} tag defines the source path and
                type used by smart. The attribute \textbf{type} setup the
                the smart type of the repository, for example,
                \textbf{type=''yast2''} and the subtag \textbf{source}
                contains the attribute \textbf{path} to setup the
                the smart location of the repository, for example,
                \textbf{source=''/image/CDs/full-i386''}. The path
                specifaction can be done as:
                \begin{itemize}
                \item local path starting with /
                \item \textbf{html://} or \textbf{ftp://} Network-Location
                \item opensuse://Project-Name
                \end{itemize}
                Multiple repository
                tags are allowed. For information on how to setup a smart
                source refer to \textit{http://labix.org/smart}
		  \item The \textbf{packages} tag contains a list of package and/or
				pattern names whereas the attribute \textbf{type} specifies
				under which cirumstances this package set needs to be used.
				There are three different types of package sets:
                \begin{itemize}
                \item \textbf{\underline{image}}\\
                      used to finish the image installation. All packages
                      which makes up the image are listed there.
                \item \textbf{\underline{boot}}\\
                      used to start buildig the image. Basic components
                      like libc or the smart package manager are listed
                      here.
                \item \textbf{\underline{xen}}\\
                      used when the image needs support for Xen based
                      virtualisation. Option \textbf{--virtual xen}
                \end{itemize}
				Using a pattern name will enhance the package list to
				a number of additional packages belonging to this pattern.
				Support for patterns is SuSE specific and available with
				openSuSE v10.2 or higher.
      \end{enumerate}
\item \textbf{\underline{cdboot}}\\
A directory containing all information required for the isolinux
boot loader. This includes the \textbf{isolinux.cfg} configuration
file, the \textbf{isolinux} directory which contains pictures, messages and
translation files for the first boot screen while booting from a CD.
In addition the \textbf{isolinux.sh} build script needs to be provided
which creates an ISO image from a prebuild CD tree requiring the mentioned
isolinux specification. According to this, the cdboot directory
only makes sense for a CD boot image. For more infomation about creating
a bootable CD, refer to chapter \ref{chapter:cdboot}.
\end{itemize}

In addition all values entered as \textbf{image} tag of the config.xml
file are stored in a file called \textbf{.profile}. The file is created
before the execution of an image script like \textit{config.sh, images.sh}
or a \textit{package script} and can then be sourced. The parameters
of the config file are then available as variables in the
script and can be processed appropriately. The script itself is called
within the image environment, which means it
is not possible to damage the host system with your script even if you
are using absolute paths. Such a script should look like the following
template:

\begin{Command}{9cm}
\textbf{\#!/bin/sh}\\
\textbf{echo -n "}Image [$<$name$>$]...\textbf{"}\\
\textbf{test -f /.profile \&\& . /.profile}\\
\\
... script code\\
\\
\textbf{echo done}
\end{Command}

The parameter \textbf{name} should be the name of the image to which this
script belongs.
