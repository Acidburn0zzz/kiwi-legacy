\index{KIWI images!deployment|(}
\chapter{Deployment of Operating System Images}
\label{chapter:dpopsysimg}
\minitoc

Creating an operating system image always implies the question
how to activate the image on the target system. As there are many
possible targets the so called image deployment higly depends on
the system environment. If a customer buys a product for example SLEPOS
the system environment is given and it is required to take care for the
rules to successfully deploy the image. On the one hand this
makes it easy for customers to control a complex system but on
the other hand one will loose the flexibility to use the same
system in another environment.

kiwi doesn't stick to a specific system environment but therefore
it leaves out important tasks concerning the deployment architecture.
So to say kiwi is an image creator but it doesn't setup the
deployment infrastructure. This chapter provides information about
the different possibilities to deploy an image and how kiwi fits
into this picture.

\section{Via network using the PXE protocol}
PXE is a boot protocol mostly implemented in todays BIOS's or
boot ROMs of some network cards. If activated it broadcasts the
network for a DHCP to obtain an IP address and the information
where to find a TFTP server to manage file transfers. If such a server
exists the second stage bootloader controls the subsequently
boot process. Using PXE with kiwi requires the infrastructure
explained in section \ref{section:tftpstruct} and a TFTP server
as well as a DHCP server running. kiwi provides the package
\textbf{kiwi-pxeboot} which setup the boot structure and installs
some prebuild boot images.

If the plan is to use a system image for which no prebuild boot image
exist, it is needed to create a custom boot image before a system image
could be deployed. Boot images consists of the image itself and
the appropriate kernel to that image. Both file must be stored in
the directory \textit{/var/lib/tftpboot/boot}. Assuming there is no
prebuild boot image for the SuSE Linux 10.2 distribution the steps
to create it are as follows:

\begin{Command}{13cm}
	cd /usr/share/kiwi/image\\
	kiwi --prepare netboot/suse-10.2 --root /tmp/myroot\\
	kiwi --create /tmp/myroot -d /tmp
\end{Command}

The result of this example is created in the /tmp directory:

\begin{verbatim}
ls -1 /tmp/initrd-netboot*
   /tmp/initrd-netboot-suse-10.2.i686-2.1.1.gz
   /tmp/initrd-netboot-suse-10.2.i686-2.1.1.kernel.2.6.18.2-31-default
\end{verbatim} 

If you don't want to prepare/create the boot image manually you
can let kiwi do the job by setting up the \textbf{pxe} type in your
system image config.xml file. For example:

\begin{Command}{15cm}
<preferences>\\
\hspace*{1cm}<type filesystem=ext3 boot=netboot/suse-10.2>pxe</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

In this case the boot image will be created automatically and from
the same source as the system image as soon as the \textbf{creation}
step is performed for the system image.

The next step is to make the boot image known to the TFTP server.
To do this the files must be copied to the \textit{/var/lib/tftpboot/boot}
directory. Optionally they can be renamed. For the following
example the boot image is renamed to \textbf{initrd} and the boot kernel
is renamed to \textbf{linux}

\begin{Command}{13cm}
	cp initrd-netboot.i686-2.1.1.gz \bs \\
	\hspace*{2cm}/var/lib/tftpboot/boot/initrd\\
	cp initrd-netboot.i686-2.1.1.kernel.2.6.18.2-31-default \bs \\
	\hspace*{2cm}/var/lib/tftpboot/boot/linux\\
\end{Command}

Switching on the target machine, which needs to run PXE by default,
will load the linux kernel and the kiwi created initrd.
The initrd will register the machine if there is no configuration
found in \textit{/var/lib/tftpboot/KIWI}. Registration means a file
including the MAC address of the machine is uploaded into the directory
\textit{/var/lib/tftpboot/upload}. For information about creating the
configuration refer to section \ref{section:confmac}. The following
example configuration fits for a machine including a disk on /dev/sda:

\begin{verbatim}
IMAGE=/dev/sda2;full-suse-10.2.i686;1.1.2;192.168.100.2;4096
PART=1024;S;x,x;L;/
DISK=/dev/sda
\end{verbatim}

According to this configuration the kiwi boot image will try to download
a system image named \textbf{full-suse-10.2.i686-1.1.2} from
the TFTP server with IP address 192.168.100.2. On the TFTP server the
system images are stored in \textit{/var/lib/tftpboot/image}. The boot
image will prepare the disk and create a 1GB swap partition and another
full size linux partition. The process of creating this full-suse-10.2 image
can be done by using kiwi. Once the boot image has successfully downloaded
the system image it is getting activated and operates as configured. 

\subsection{Via TFTP with initial boot from CD or USB stick}
Sometimes it is not possible to use PXE as boot protocol. This could happen
if the target machine doesn't support PXE or the installed network card
doesn't provide a PXE boot rom. Preconditioned your network provides
a DHCP and a TFTP server the problem can be solved by storing the
boot image on another bootable medium like a CD or an USB stick.
Referring to the information from the section above it is easy to create
a bootable CD / USB stick with kiwi:

\begin{Command}{14cm}
	kiwi --bootcd /tmp/initrd-netboot-suse-10.2.i686-2.1.1.gz
\end{Command}

The command will create a bootable ISO image which only needs to be
burned on a CD. The following file will be created after the call:
\textit{/tmp/initrd-netboot-suse-10.2.i686-2.1.1.cdboot.iso}

\begin{Command}{14cm}
    -plug in an USB stick then call-\\
	kiwi --bootstick /tmp/initrd-netboot-suse-10.2.i686-2.1.1.gz
\end{Command}

The command will create a bootable USB stick. kiwi is searching for
the USB stick plugged in before and lists all devices found. The user
needs to select one of the devices by typing one of the suggested
device names. It is important to be careful at that stage because
all data on the given device will be lost. Because of this reason
the user has to type the device name which hopefully increases the
chance not to do something thoughtlessly.

\section{Installation on client via CD}
If there is no network infrastructure available a client can only receive
the system image from a storage media like a CD or an USB stick. This section
explains how to create a CD with kiwi which supports system image
installation to the storage device of the client. The following steps
needs to be processed:
\begin{enumerate}
\item Create the boot image which takes over the task of installing the
      system image. For that purpose kiwi provides the \textbf{isoinstboot}
      boot image type.
\item Next step is creating the system image which should make it on the
      client. The boot and the system image package source should be the same.
      The system image description requires a \textbf{deploy} section within
      the config.xml file. The deploy section describes how the clients
      storage device should be partitioned and which device is the root
      device for the later image.
\item Last step is to create an .iso file together with the boot- and
      system image. Therefore call kiwi like the following example:
	  \textbf{kiwi --installcd bootImageName --installcd-system systemImageName}
\end{enumerate}

\section{Installation on client via USB stick}
*** not yet implemented ***
%TODO ..

\section{Split image system via PXE}
kiwi supports system images to be splitted into two parts, a read-only
part and a read-write part. This allows to put data on different
filesystems which is mostly used to have read-only data available on
a compressed filesystem like cramfs or squasfs. Please note that almost
all compressed filesystems available have some kind of restrictions
which needs attention before starting to use it in an image.
 
To turn a system image into a split image only the type of the image
must be adapted. This information is part of the \textbf{config.xml}
file and could be changed like the following example shows:

\begin{Command}{12cm}
<preferences>\\
\hspace*{1cm}<type filesystem=ext3,cramfs>split</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

Creating an image from this description results in two image files
whereas one of them will contain the \textbf{-read-only} extension
in its name. Ay one may imagine booting such an image always requires
a boot process which must be able to bring both images together again.
Because of this, split images can only deployed in combination with
one of the kiwi boot images.

To deploy the image only PXE or a boot CD / USB-stick can be used.
The most important part while making use of split images is the
configuration for the target machine. More information on this config.MAC
file can be found in section \ref{section:confmac}. In case of a split
image the following information must be provided:

\begin{itemize}
\item The IMAGE key must contain both images the read-write and the read-only
      image. The read-write image must appear as first entry in the list
\item The PART key has to specifiy a partition table with at least three
      partitions. A swap partition and two system partitions which provides
      enough space for the first and the second image portion
\item The Option COMBINED\_IMAGE to tell the boot image to combine both
      images into one entire system
\end{itemize}

The following example shows the configuration of a split image named
minimal-10.1 / minimal-10.1-read-only

\begin{verbatim}
IMAGE=/dev/sda2;minimal-10.1.i686;1.1.2;192.168.100.2;4096,\
      /dev/sda3;minimal-10.1-read-only.i686;1.1.2;192.168.100.2;4096
PART=200;S;x,500;L;/,x;L;
DISK=/dev/sda
COMBINED_IMAGE=yes
\end{verbatim}

\section{Via network using NFS mounted root system}
In principal kiwi was designed to upload an image onto a client in different
ways but out there you will find diskless machines as well. Those devices
doesn't provide permanent storage and rely on the network. The most oft used
process to activate such terminals is to NFS mount the system image via
the network. kiwi supports that as well but it additionally requires a
terminal server configuration which needs to export the system image using
a NFS server. The following steps needs to be performed in order to activate
a diskless station:
\begin{enumerate}
\item Prepare the system image using\\
      \textbf{kiwi --root /tmp/kiwi.nfsroot --prepare ...}
\item Setup a NFS server which exports the /tmp/kiwi.nfsroot path. The
      following export options in /etc/exports are recommended:\\
      \textbf{/tmp/kiwi.nfsroot  *(rw,no\_root\_squash,sync,no\_subtree\_check)}
\item Create an appropriate netboot boot image (initrd) with kiwi. Appropriate
      means the package repository for the system image and the netboot image
	  must be the same
\item Copy the boot image/kernel to the PXE server in /var/lib/tftpboot/boot
      The package kiwi-pxeboot helps you in setting up the PXE/TFTP server
\item Create a config.<MAC> file in /var/lib/tftpboot/KIWI with the following
      contents:
\begin{verbatim}
NFSROOT=129.168.100.7;/tmp/kiwi.nfsroot
\end{verbatim} 
\item Boot the client. If everything works the client will receive the boot
      image and kernel via PXE/TFTP. The boot image NFS mounts the system image
      according to the data in config.<MAC>. After that the mounted root filesystem
      will be activated  
\end{enumerate}

\section{USB stick system}
A very popular method is storing complete operating systems on an USB
stick. This means not only the boot image and the kernel is stored on
the stick but also the entire system image is part of the stick.
To be able to do this kiwi provides special boot image(s) located in
\textbf{/usr/share/kiwi/image/usbboot}. Currently it is tested and available
for SuSE Linux 10.2 only but can be adapted to other versions as well.
To use your system image on a boot stick setup the system's config.xml
as follows:

\begin{Command}{15cm}
<preferences>\\
\hspace*{1cm}<type filesystem=ext3 boot=usbboot/suse-10.2>usb</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

After this the boot and system image needs to be
created. Concerning to the size of the stick the image is not allowed to
grow beyond it. Assuming the system image is named full-suse-10.2
the command is as follows:

\begin{Command}{14cm}
	kiwi --prepare full-suse-10.2 --root /tmp/mysystem\\
	kiwi --create /tmp/mysystem -d /tmp
\end{Command}

The result of the command above is represented in the image file
\textit{/tmp/full-suse-10.2.i686-1.1.2}. The usbboot image is created
automatically and is stored as
\textit{/tmp/initrd-usbboot-suse-10.2.i686-2.1.1.gz}.
To create a bootable stick with a SuSE Linux 10.2 operating system on
it, plug in the stick and call:

\begin{Command}{14cm}
	-plug in an USB stick then call-\\
	kiwi --bootstick /tmp/initrd-usbboot-suse-10.2.i686-2.1.1.gz \bs\\
    \hspace*{1.1cm}--bootstick-system /tmp/full-suse-10.2.i686-1.1.2
\end{Command}

\section{Virtual disk system (QEMU or VMware)}
To be able to use a virtualization system a virtual disk needs to
be created. This can be done by specifying the following type in the
system's image config.xml:

\begin{Command}{16cm}
<preferences>\\
\hspace*{1cm}<type filesystem=ext3 boot=vmxboot/suse-10.2>vmx</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

After this the system image can be created. The process will create the
system image and the specified vmxboot/suse-10.2 boot image. The result
is then used to create the virtual disk. The following command needs
to be called:

\begin{Command}{14cm}
	kiwi --prepare full-suse-10.2 --root /tmp/mysystem\\
	kiwi --create /tmp/mysystem -d /tmp
\end{Command}

The result of the command above is a set of virtual disks, one with
suffix .qemu and the other with the suffix .vmdk (VMware). To run the
system on the virtual disk with for example qemu call:

\begin{Command}{14cm}
	qemu /tmp/full-suse-10.2.i686-1.1.2.qemu
\end{Command}

\section{Para virtual image for Xen}
To be able to use an image within Xen a system image and an initrd file
needs to be created. This can be done by specifying the following type in the
system's image config.xml:

\begin{Command}{16cm}
<preferences>\\
\hspace*{1cm}<type filesystem=ext3 boot=xenboot/suse-10.2>xen</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

After this the system image can be created. The process will create the
system image and the specified xenboot/suse-10.2 boot image. Additionally
an appropriate Xen configuration file will be created. The config file
will use the \textbf{.xenconfig} suffix. The following command needs
to be called:

\begin{Command}{14cm}
    kiwi --prepare full-suse-10.2 --root /tmp/mysystem\\
    kiwi --create /tmp/mysystem -d /tmp
\end{Command}

To run the system within Xen one need to call:

\begin{Command}{14cm}
   xm create -c /tmp/full-suse-10.2.i686-1.1.2.xenconfig
\end{Command}

\section{Live CD system}
Normally an image will be installed on a disk or into the
main memory of a computer. This is done by a deployment
architecture which transfers the image via a boot image
into its final destination. such a boot image can also
exist on a CD. The task of the CD-Boot image is to setup
a system which is divided into two parts:

\begin{itemize}
	\item Read-Only part which is obtained from the CD
	\item Read/Write part which is pushed into main memory
\end{itemize}

An image which works partially on disk and partially on RAM
is called a live CD system. The CD-Boot structure of KIWI will
put the directories \textit{/bin, /boot, /lib, /opt, /sbin and /usr}
on the CD and the rest into the main memory of the system.

\subsection{How do you setup an image as live CD}
To create an .iso image which can be burned on CD you only need
to specify the boot image which should handle your live system.
This is done by setting the \textbf{type} of the image in the
\textbf{config.xml} file as follows:

\begin{Command}{12cm}
<preferences>\\
\hspace*{1cm}<type boot="isoboot/suse-10.3">iso</type>\\
\hspace*{1cm}...\\
</preferences>
\end{Command}

The attribute \textbf{boot} refers to the CD boot image which
must exist in \textit{/usr/share/kiwi/image/isoboot}. Like for all boot
images the most important point is that the boot image has to
match the operating system image. This means the kernel of the boot-
and operating system image must be the same. If there is no
boot image which matches you need to create your own boot image
description. A good starting point for this is to use an existing
boot image and adapt it to your needs.

\subsection{How does the boot image work}
The boot process from a CD works in five steps:

\begin{enumerate}
\item After the image has been prepared which means a physical extend
      exists the process of building the logical extend will split
      the physical part into two physical extends:
      \begin{itemize}
      \item read/write extend which is loaded into RAM
      \item read-only extend consisting of the data stored
            in the \textit{/bin, /boot, /lib, /opt, /sbin and /usr}
            directories
      \end{itemize}
\item From the two physical extends kiwi will create two ext2
      based logical images.
\item Next kiwi prepares and creates in one step the boot image given 
      as the type of the image configuration file config.xml.
\item Next kiwi will setup the CD directory structure and copy all
      image and kernel files as well as the isolinux data into this
      directory tree.
\item At last kiwi calls the \textbf{isolinux.sh} script provided
      by the ISO boot image to create an .iso file from the CD
      directory tree.
\end{enumerate}
