\chapter{EC2 Image---Amazon Elastic Compute Cloud}
\index{KIWI images!EC2|(}\index{EC2|see{KIWI images, EC2 }}\index{Cloud|see EC2 }
\label{chapter:ec2}
\minitoc

The Amazon Elastic Compute Cloud (Amazon EC2) web service provides you
with the ability to execute arbitrary applications in our computing
environment. To use Amazon EC2 you simply:

\begin{enumerate}
\item Create an Amazon Machine Image (AMI)\index{Amazon Machine Image}%
      \index{AMI|see Amazon Machine Image}
      containing all your software,
      including your operating system and associated configuration settings,
      applications, libraries, etc. Such an AMI can be created by the KIWI
      ec2 image format. In order to do that KIWI makes use of the tools
      provided by Amazon. Your build system should have these tools
      installed. Due to license issues we are not allowed to distribute
      the tools which means you need to download, install and setup
      them from here:\\
      \url{http://aws.amazon.com/documentation/ec2/}
\item Upload this AMI to the Amazon S3 (Amazon Simple Storage Service)
      \index{Amazon Simple Storage Service}\index{Amazon S3|see Amazon Simple Storage Service}
      service. This gives us reliable, secure access to your AMI.
\item Register your AMI with Amazon EC2. This allows us to verify that your
      AMI has been uploaded correctly and to allocate a unique identifier
      for it.
\item Use this AMI ID and the Amazon EC2 web service APIs to run, monitor,
      and terminate as many instances of this AMI as required. Currently,
      Amazon provides command line tools and Java libraries but you may also
      directly access the SOAP-based API.
\end{enumerate}

Please note while instances are running, you are billed for the
computing and network resources that they consume.
You should start creating an ec2 with KIWI after you can make sure
your system is prepared for ec2 which means if you call the command
\cmd{ec2-describe-images} \soption{a} you will get a valid output.

\section{Building the suse-xen-guest Example for EC2}

One example provided with KIWI is based on openSUSE 11.3 and
includes the base pattern plus the vim editor.

Before you run KIWI you need to include some of your ec2 account
information into the image description \path{config.xml} file. The box
below shows the values you need to adapt:

\begin{xml}
<ec2config>
  ec2accountnr="12345678911"
  ec2privatekeyfile="Path to EC2 private key file"
  ec2certfile="Path to EC2 public certificate file"
</ec2config>
\end{xml}

After that call KIWI as follows:

\begin{Command}{13cm}
cd /usr/share/doc/packages/kiwi/examples
cd suse-11.3
kiwi --prepare ./suse-xen-guest \
     --add-profile ec2Flavour \
     --root /tmp/myec2
\end{Command}

\begin{Command}{13cm}
kiwi --create /tmp/myec2 \
     --add-profile ec2Flavour \
     --type vmx -d /tmp/myec2-result
\end{Command}

\section{Using the Image}
The generated image needs to be transfered over to Amazon which is
done by the ec2-upload-bundle tool. You can do this by calling:

\begin{Command}{13cm}
ec2-upload-bundle -b myImages \
 -a <AWS Key ID> -s <AWS secret Key ID> \
 -m /tmp/myec2/\
    suse-11.1-xen-guest.i686-1.1.2.ami.manifest.xml
\end{Command}

After this is done the image needs to be registered in order to
receive a so called AMI id which starts with \path{ami-} followed
by a random key sequence. To register call:

\begin{Command}{13cm}
ec2-register myImages/\
    suse-11.1-xen-guest.i686-1.1.2.ami.manifest.xml
\end{Command}

The result is the AMI id which you need to run an instance from
your image. The command \cmd{ec2-describe-images} allows you to review your
registered images. Since you will be running an instance of a public AMI,
you will need to use a public/private keypair to ensure that only you
will have access. One half of this keypair will be embedded into your
instance, allowing you to login securely without a password using the
other half of the keypair. Every keypair you generate requires a name.
Be sure to choose a name that is easy to remember, perhaps one that
describes the image's content. For our example we'll use the name
gsg-keypair.

\begin{Command}{10cm}
ec2-add-keypair gsg-keypair
\end{Command}

The private key returned needs to be saved in a local file so that
you can use it later. Using your favorite text editor, create a file
named \path{id_rsa-gsg-keypair} and paste everything between
(and including) the \texttt{-{}-{}-{}-{}-BEGIN RSA PRIVATE KEY-{}-{}-{}-{}-} and
\texttt{-{}-{}-{}-{}-END RSA PRIVATE KEY-{}-{}-{}-{}-} lines into it. To review
your keypairs call:

\begin{Command}{10cm}
ec2-describe-keypairs
\end{Command}

We are almost done now but to be able to run an instance it's
required to select an appropriate AKI ID from the
\textit{Amazon Kernel Image IDs} table below. For this host,
\textit{aki-407d9529} is being chosen, because we are bundling
an AMI representing a virtual disk with PVGrub. If the table
below is outdated just check the current ID list at Amazon
directly

\begin{tabular}[h]{|p{3cm}|p{6cm}|}
\hline
\textbf{AKI} & \textbf{Name} \\
\hline
aki-407d9529 & \path{ec2-public-images/pv-grub-hd0-V1.01-i386.gz.manifest.xml} \\
aki-427d952b & \path{ec2-public-images/pv-grub-hd0-V1.01-x86_64.gz.manifest.xml} \\
\hline
\end{tabular}\\

Fire up your new ec2 instance with the following command:

\begin{Command}{13cm}
ec2-run-instances ami-... \
  --kernel aki-407d9529 \
  -k gsg-keypair
\end{Command}

To check the state of your instance(s) call the following command:

\begin{Command}{10cm}
ec2-describe-instances
\end{Command}

If you see your instance at the status: \textbf{running} you can login
into it. If you can't make sure you have allowed port 22 to be available

\begin{Command}{10cm}
ec2-authorize default -p 22
\end{Command}

Congratulations ! You made it and can now use Amazons storage and
computing power.


\index{KIWI images!EC2|)}
