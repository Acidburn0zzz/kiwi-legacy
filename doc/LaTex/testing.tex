\index{KIWI images!testing|(}
\chapter{KIWI testsuite}
\label{chapter:testing}
\minitoc

The KIWI test suite is useful to perform basic quality checks on
the image root directory. The test cases are stored in subdirectories
below /usr/share/kiwi/tests. To run the testsuite call kiwi as
follows:

\begin{Command}{12cm}
 kiwi $--$testsuite <image-root> \bs \\
\hspace*{1cm}[ $--$test name $--$test name ... ]
\end{Command}

If not test names are set the default tests rpm and ldd run.
The name of a test corresponds with the name of the directory
the test is implemented in.

\section{testsuite packages}
If a test requires special software to be installed but this
software is not an essential part of the image itself it can be
specified as testsuite packages in the system image config.xml
as follows:

\begin{Command}{12cm}
<packages type="testsuite">\\
\hspace*{1cm}<package name="..."/>\\
</packages>
\end{Command}

The testsuite packages are installed when calling kiwi with
the testsuite option and are removed after the tests has
finished.

\section{Creating a test}
The test itself is defined by a xml description ''test-case.xml''
and its template definition file /usr/share/kiwi/modules/KIWISchemeTest.rnc
The following example shows the basic structure of the rpm test:

\begin{verbatim}
<test_case 
  name="rpm"
  summary="check rpm database and verify all rpms"
  description="check if rpm db is present, run rpm`s build-in Verify method"

  <requirements>
     <req type="directory">/var/lib/rpm</req>
     <req type="file">/var/lib/rpm/__db.000</req>
     <req type="file">/var/lib/rpm/Packages</req>
  </requirements>

  <test type="binary"  place="extern">
     <file>rpm.sh</file>
     <params>CHROOT</params>
  </test>
</test_case>
\end{verbatim}

There are basically two sections called ''equirements'' and ''test''.
In requirements you define what files/directories or packages has to be
present in your image to run the test. For example if you need to check
the rpm database, the database has to be present within the image.
All requirements are checked, and if any of them fail the test won't be
executed and an error message is printed. There are three types of
requirements:

\begin{itemize}
\item \textbf{file}\\
      Existence of a file
\item \textbf{directory}\\
      Existence of a directory
\item \textbf{rpm-package}\\
      Existence of a package
\end{itemize}

The test section defines the test script. It could be a binary,
shell script or any other kind of executable. Scripts are expected to be in
the same directory as where the xml definition for the test resides.
There are two types of scripts, extern and intern.

\begin{itemize}
\item external scripts are executed outside of the image and are preferred.
      Their first parameter should be CHROOT. This parameter
      is changed to the real path of the image chroot directory.

\item internal scripts are executed inside image using the ''chroot'' command.
      Files are copied into the image and deleted after execution.
\end{itemize}

A test script always has to return 0 in case of a test to pass, or 1 if
any error occur. All messages printed to standard and error output are stored
and printed out of the test has failed.


