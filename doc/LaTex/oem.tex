\index{KIWI images!oem|(}
\chapter{OEM Image---Preload Systems}
\label{chapter:oem}
\minitoc

An oem image is a virtual disk image representing all partitions
and bootloader information in the same fashion it exists on a physical
disk. The image format matches the format of the VMX image type. All flavors
discussed previously for the VMX image type apply to the OEM image type.

The basic idea behind an oem image is to provide the virtual disk data
for OEM vendors to support easy deployment of the system to physical
storage media. The deployment can be performed from any OS including
Windows as long as a tool to dump data onto a disk device exists and is 
used. The oem image type may also be used to deploy an image on a USB stick. 
A USB stick is simply a removable physical storage device.

\section{Building the suse-oem-preload Example}

The OEM example provided with kiwi is based on recent openSUSE releases, 
one example configuration per release, and includes the default and x11 
patterns. The image type is a split type utilizing the distributions default
filesystem format for the read-write partition and the squashfs filesystem 
for the read-only partition. Using the additional \xmlattr{installiso} attribute 
creates an installable ISO image. When booting from the ISO image the
OEM disk image will be deployed to the storage media on the booting machine
(after confirmation by the user).

The commands provided below use the openSUSE 11.2 based example built 
for the x86 architecture.

\begin{Command}{12cm}
cd /usr/share/doc/packages/kiwi/examples
cd suse-11.2
kiwi --prepare ./suse-oem-preload --root /tmp/myoem
\end{Command}

\begin{Command}{12cm}
kiwi --create /tmp/myoem --type split -d /tmp/myoem-result
\end{Command}

\section{Using the Image}

The virtual disk image created by KIWI with the commands shown above can be 
tested using virtualization software such as QEMU, VMware, or VirtualBox. 
The virtual disk is represented by the file with the \path{.raw} extension, whereas 
the file with the .iso extension represents the installation disk for this oem
image. The ISO image is bootable \path{(filename.iso)} and can be burned to 
optical media. It is recommended to test the image on a bare test system. The 
following command shows how to use qemu to test the oem disk image 
\textit{(filename.raw)}.

\begin{Command}{12cm}
cd /tmp/myoem-result
qemu suse-11.2-oem-preload.i686-1.1.2.raw -m 512
\end{Command}

or using the \cmd{dd} command you can dump the image onto a test hard 
disk or USB stick and upon reboot select the appropriate device as the 
boot device in the BIOS:

\begin{Command}{12cm}
cd /tmp/myoem-result
dd if=suse-11.2-oem-preload.i686-1.1.2.raw \
   of=/dev/<device> bs=32k
\end{Command}

Please note, when testing an oem image using the virtual disk image, i.e. 
the .raw file, the geometry of the disk image is not changed and therefore 
retains the disk geometry of the host system. This implies that the 
re-partitioning performed for a physical disk install during the oem boot 
workflow will be skipped.

You can test the installation procedure in a virtual environment using
the \path{.iso} file. In this case the re-partitioning code in the boot image will
be executed. The following commnads show this procedure using QEMU.

\begin{Command}{12cm}
cd /tmp/myoem-result
qemu-img create /tmp/mydisk 20G
qemu -hda /tmp/mydisk -cdrom \
     suse-11.2-oem-preload.i686-1.1.2.iso \
     -boot d
\end{Command}

\section{Flavors}

As indicated above the use of the \xmlattr{installiso} and \xmlattr{installstick}
 attributes for the oem image supports the creation of an installation image.
The installation image can be created in two formats, one suitable for
CD/DVD media and a second suitable for a USB stick. The self installing
image deploys the oem image onto the selected storage device. The
installation process is a simple image dump using the dd command. During
this process the target system
remains in terminal mode. The following configuration snippets show the 
use of the \xmlattr{installiso} and \xmlattr{installstick} attributes
to create the ISO or USB installation image format respectively.

\begin{itemize}
\item \xmlemptytag{type \xmlattrval{image}{name} ... \xmlattrval{installiso}{true}}\\
      Creates a \path{.iso} file which can be burned in CD or DVD. This
      represents an installation CD
\item \xmlemptytag{type \xmlattrval{image}{name} ... \xmlattrval{installstick}{true}}\\
      Creates a \path{.raw.install} file which can be dumped (dd) on a
      USB stick. This represents an installation Stick
\end{itemize}

\subsection{Influencing the OEM Partitioning}

By default the oemboot process will create/modify a swap, \path{/home} and \path{/}
partition. It is possible to influence the behavior with the
oem-* elements. See the \textit{KIWI image description} chapter for details.

%If you plan to use a custom partition setup you also should consider
%to create a copy of the original oemboot boot image description. The following
%workflow should be used to integrate a custom config.oempartition:

%\begin{enumerate}
%\item Clone the used boot image description
%\begin{verbatim}
%cp -a /usr/share/kiwi/image/oemboot/suse-... \
%      /usr/share/kiwi/image/oemboot/suse-...-myoem
%\end{verbatim}
%\item Copy the config.oempartition file into the boot image description 
%\begin{verbatim}
%cp config.oempartition \
%   /usr/share/kiwi/image/oemboot/suse-...-myoem/root
%\end{verbatim}
%\item Sign your new boot image description
%\begin{verbatim}
%kiwi --createhash \
%     /usr/share/kiwi/image/oemboot/suse-...-myoem
%\end{verbatim}
%\item Make sure your system image use the new boot image
%\begin{verbatim}
%<type ... boot="oemboot/suse-...-myoem">...</type>
%\end{verbatim}
%\end{enumerate}

\subsection{LVM Support}

KIWI also provides support for LVM (Logical Volume Management). In this
mode the disk partition table will include one lvm partition and one
standard ext2 boot partition. KIWI creates the kiwiVG volume group, unless
the lvmgroup attribute has been set, and adds logical volumes to the group
based on the configuration given by the \textbf{lvmvolumes} block
for this type. The filesystem for the volume group is determined by the
filesystem attribute of the type element. After booting the system the user
has full control over the volume group and is free to change
(resize/increase) the group and the volumes inside. Support for LVM has
been added for all disk based image types. This includes the vmx, oem and
usb image types. In order to use LVM for the oem type just add the 
\verb+--lvm+ command line option when executing the create step or add
the attribute \xmlattrval{lvm}{true} to of the \xmlelement{type} 
element in your \path{config.xml} file.

\begin{Command}{12cm}
kiwi --create /tmp/myoem --type oem -d /tmp/myoem-result --lvm
\end{Command}

With the optional \textbf{lvmvolumes} section you can specify to have 
one or more top level directories in a separate volume. See the
\textit{KIWI image description} chapter for a detailed explanation.

\subsection{Partition Based Installation}

The default installation method of an OEM is dumping the entire
virtual disk on the selected target disk and repartition the disk
to the real geometry. This works but will also wipe everything which
was on the disk before. KIWI also supports the installation into
already existing partitions. This means the user can setup a disk
with free partitions for the KIWI OEM installation process. This
way already existing data will not be touched. In order to activate
the partition based install mode the following oem option has to
be set in \path{config.xml}:

\begin{xml}
<oem-partition-install>true</oem-partition-install>
\end{xml}

Compared to the disk based install the following differences
should be mentioned:

\begin{itemize}
\item The bootloader will be setup to boot the installed system. There
      is no multiboot setup. The user has to take care for the setup
      of a multiboot bootloader himself.
\item The oem options for system, swap and home doesn't have any effect
      if the installation happens in predefined partitions
\item There is no support for remote (PXE) OEM installation because kiwi
      has to loop mount the disk image in order to access the partitions
      which can't be done remotely
\item The raw disk image is stored uncompressed on the install media.
      This is because KIWI needs to loop mount the disk image which it can't
      do if the file is only available as compressed version. This means
      the install media in this mode will be approximately double the size
      of a standard install media
\end{itemize}
