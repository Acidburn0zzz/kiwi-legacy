\index{KIWI images!migration|(}
\chapter{System to image migration}
\label{chapter:migration}
\minitoc

KIWI provides an experimental module which allows you to turn your
running system into an image description. This migration allows you
to clone your currently running system into an image. The process
has the following limitations at the moment:

\begin{itemize}
\item Works for SUSE systems only
\item You can't rely on the result to be a 100\% ready to use copy
      of your system. This means some manual postprocessing might
      be necessary
\end{itemize}

When calling KIWI's migrate mode it will try to find the base version
of your operating system and assigns a predefined repository to recreate
the data which exists in terms of packages. The code inspect your
system and creates a list of packages and patterns which represents
your system so far. Of course there are normally some data which
doesn't belong to any package. These are your configurations your user
data and all other stuff. KIWI collects all this information and would
copy it as overlay files as part of the image description. The process
will skip all remote mounted filesystems and concentrate only on local
filesystems.

\section{Create a clean repository set first}
When starting with the migration it is useful to let kiwi know about all
the repositories from which packages has been installed to 
the system. In a first step call:

\begin{Command}{12cm}
\begin{verbatim}
kiwi --migrate mySys --destdir /tmp/migrated \
     --report-packlist
\end{verbatim}
\end{Command}

This will only check which packages and patterns could be assigned
to the given base repository. In almost all cases there will be
information about packages which couldn't be assigned. You should
go to that list and think of the repository which contains that
packages (pacman, etc...). A good starting point is the
output of \verb+zypper sl --details+. If you know about the repositories
just add then in subsequent calls like:

\begin{Command}{16cm}
\begin{verbatim}
kiwi --migrate mySys --destdir /tmp/migrated \
     --add-repo \
     http://packman.mirrors.skynet.be/pub/packman/suse/11.0 \
     --add-repotype rpm-dir
     --report-packlist
\end{verbatim}
\end{Command}

You should continue the migration if you have a clean list of solved
packages without any package skipped except you know that this package
can't be provided or is not worth to become part of the migration.

\section{Create a migration report first}
When running the next step of the migration I
recommend to create a report first:

\begin{Command}{12cm}
\begin{verbatim}
kiwi --migrate mySys --destdir /tmp/migrated \
     --add-repo ... --add-repotype ...
     --report
\end{verbatim}
\end{Command}

After that call you should walk through the following check list

\begin{itemize}
\item check the contents of the config.sh script. The migration
      added at least the services your system runs and adds them
      to the configuration script. Check this service list
\item check the report file contents. All data which doesn't belong
      to a package are listed there. You should make sure whether you
      need them all or if you could exclude some of them. As a
      recommendation, you should have as little as possible overlay
      files.
\item check the created config.xml image description file. You should
      at least make sure if the repository is correct and if you need
      more repositories for packages which are not part of the base
      repository for example
\end{itemize}

\section{Migrate my system...}
After the check list you will have a good impression of your system.
What data is there what's not part of packages what doesn't need to
be part of the image description and so on. You can exclude the
directories which you don't need according to the report file with
the \verb+--+exclude parameter. Now you can call migrate again and let
it copy the overlay files too:

\begin{Command}{12cm}
\begin{verbatim}
rm -rf /tmp/migrated
kiwi --migrate mySys --destdir /tmp/migrated \
     --add-repo ... --add-repotype ...
     --exclude directory --exclude ...
\end{verbatim}
\end{Command}

\section{Turn my system into an image...}
After the process has finished you should check the size of the
image description. The description itself shouldn't be that big.
The size of a migrated image description mainly depends on how many
overlay files exists in the root/ directory. You should really make
sure whether you need them all or not. Now let's try to create a
clone image from the description. The most appropriate image type
to do this is the virtual disk image (vmx)

\begin{Command}{12cm}
\begin{verbatim}
kiwi -p /tmp/migrated --root /tmp/mySys
kiwi --create /tmp/mySys -d /tmp/myResult \
     --type vmx
\end{verbatim}
\end{Command}

If everything worked well you can test the created virtual disk
image in any full virtual operating system environment like QEMU or
VMware. Once created the image description can serve for all image
types kiwi supports.
 
