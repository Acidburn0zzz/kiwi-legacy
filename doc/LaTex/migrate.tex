\index{KIWI images!migration|(}
\chapter{System to image migration}
\label{chapter:migration}
\minitoc

KIWI provides an experimental module which allows you to turn your
running system into an image description. This migration allows you
to clone your currently running system into an image. The process
has the following limitations at the moment:

\begin{itemize}
\item Works for SUSE systems only (with zypper on board)
\item The process works semi automatically which means depending
      on the complexity of the system some manual postprocessing might
      be necessary
\end{itemize}

When calling KIWI's migrate mode it will try to find the base version
of your operating system and uses the currently active repositories
specified in the zypper database to match the software which exists
in terms of packages and patterns. The result is a list of packages
and patterns which represents your system so far. Of course there are
normally some data which doesn't belong to any package. These are
for example configurations or user data. KIWI collects all this
information and would copy it as overlay files as part of the image
description. The process will skip all remote mounted filesystems
and concentrate only on local filesystems.

\section{Create a clean repository set first}
When starting with the migration it is useful to let kiwi know about all
the repositories from which packages has been installed to 
the system. In a first step call:

\begin{Command}{12cm}
\begin{verbatim}
kiwi --migrate mySys -d /tmp/migrated
\end{verbatim}
\end{Command}

This will create an HTML report where you can check which packages and
patterns could be assigned to the given base repository. In almost
all cases there will be information about packages which couldn't
be assigned. You should go to that list and think of the repository
which contains that packages (pacman, etc...). If something is missing
add it either to the zypper list on your system or use the kiwi
options --add-repo ... --add-repotype

Continue calling the following command until your list is clean
You should continue the migration if you have a clean list of solved
packages without any package skipped except you know that this package
can't be provided or is not worth to become part of the migration.

\begin{Command}{14cm}
\begin{verbatim}
kiwi --migrate mySys -d /tmp/migrated --nofiles \
     [ --skip package ... ]
\end{verbatim}
\end{Command}

\section{Watch the packaged but modified files}
now watch the packaged but modified files in /tmp/mysys/root-modified
and remove all files you don't need. If you are ready with this task
copy the root-modified files over to the root/ directory

\section{Watch the unpackaged files}
now watch the unpackaged files in root-nopackage. This is most likely
the hardest part of the migration. remove all files and directories
you don't need and after that copy the tree over to the root/ directory

\section{Checklist}
After that you should walk through the following check list

\begin{itemize}
\item change author and contact in config.xml
\item set appropriate name for your image in config.xml
\item add/modify default type (oem) set in config.xml if needed
\item make sure your X11 configuration is appropriate according to
      the new target. A failsafe version was created in
      /tmp/mysys/root/etc/X11/xorg.conf.install -> fbdev based
\item make sure yast2 is installed to be able to reconfigure
      the system. if yast2 is not installed these tasks needs to
      be done else. Otherwise yast's second stage is started on first
      boot of the migrated image
\item if you want to access any remote filesystem it's a good
      idea to let autoyast add them on first boot of the system
\item check your network setup in /etc/sysconfig/network. Is this
      setup still possible in the cloned environment ? Make sure you
      check for the MAC address of the card first
\end{itemize}

\section{Turn my system into an image...}
After the process has finished you should check the size of the
image description. The description itself shouldn't be that big.
The size of a migrated image description mainly depends on how many
overlay files exists in the root/ directory. You should make
sure to maintain only required overlay files. Now let's try to create a
clone image from the description. By default an OEM image which is
a virtual disk which is able to run on real hardware too is created.
On success you will also find a ISO file which is an installable
version of the OEM image. If you burn the ISO on a DVD you can use
that DVD to install your cloned image on another computer.

\begin{Command}{14cm}
\begin{verbatim}
kiwi -p /tmp/migrated --root /tmp/mySys
kiwi --create /tmp/mySys -d /tmp/myResult
\end{verbatim}
\end{Command}

If everything worked well you can test the created OEM
image in any full virtual operating system environment like QEMU or
VMware. Once created the image description can serve for all image
types kiwi supports.
 
