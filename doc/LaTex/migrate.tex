\index{KIWI images!migration|(}
\chapter{System to Image Migration}
\label{chapter:migration}
\minitoc

KIWI provides an experimental module which allows you to turn your
running system into an image description. This migration allows you
to clone your currently running system into an image. The process
has the following limitations at the moment:

\begin{itemize}
\item Works for SUSE systems only (with zypper on board)
\item The process works semi automatically which means depending
      on the complexity of the system some manual postprocessing might
      be necessary
\end{itemize}

When calling KIWI's migrate mode it will try to find the base version
of your operating system and uses the currently active repositories
specified in the zypper database to match the software which exists
in terms of packages and patterns. The result is a list of packages
and patterns which represents your system so far. Of course there are
normally some data which doesn't belong to any package. These are
for example configurations or user data. KIWI collects all this
information and would copy it as overlay files as part of the image
description. The process will skip all remote mounted filesystems
and concentrate only on local filesystems.

\section{Create a Clean Repository Set First}
When starting with the migration it is useful to let kiwi know about all
the repositories from which packages has been installed to 
the system. In a first step call:

\begin{Command}{12cm}
kiwi --migrate mySystem
\end{Command}

This will create an HTML report where you can check which packages and
patterns could be assigned to the given base repository. In almost
all cases there will be information about packages which couldn't
be assigned. You should go to that list and think of the repository
which contains that packages (pacman, etc). If something is missing
add it either to the zypper list on your system or use the KIWI
options \option{add-repo} \ldots \option{add-repotype}.

Continue calling the following command until your list is clean
You should continue the migration if you have a clean list of solved
packages without any package skipped except you know that this package
can't be provided or is not worth to become part of the migration.

\begin{Command}{8cm}
kiwi --migrate mySystem --nofiles [ --skip package ... ]
\end{Command}

\section{Watch the Overlay and Unpackaged Files}
Files which has been modified but belong to a package will be
automatically copied into the overlay directory below
\path{/tmp/mySystem/root}. You should check that no modified file
is a binary because such a binary would be replaced by a new
install of the package anyway. As a software deloper people
tend to compile software from source and copy/install them
into their system. Doing this could cause binary files previosly
installed by a package to be reported as modified. You should
remove such files from your overlay tree.

The migration also copy the entire \path{/etc} directory into the
overlay root directory because it stores all important configuration
files. Beside the important files there are most probably a bunch
of file which doesn't belong to any package exists only for
historical reasons. kiwi creates a list of files and
directories to support you best in sorting out what is required
and what can be ignored. Nevertheless this is the most
time consuming part of your migration review. Simply click on
the \textit{all unpackaged files} link to take a look at the
complete list. Those files you want to have in your image needs
to be copied over to the \path{/tmp/mySystem/root} directory

\section{Checklist}
After that you should walk through the following check list

\begin{itemize}
\item Change author and contact in \path{config.xml}
\item Set appropriate name for your image in \path{config.xml}
\item Add/modify default type (oem) set in \path{config.xml} if needed
\item Make sure your X11 configuration is appropriate according to
      the new target. A failsafe version was created in
      \path{/tmp/mysys/root/etc/X11/xorg.conf.install} -> fbdev based
\item Make sure \cmd{yast2} is installed to be able to reconfigure
      the system. if \cmd{yast2} is not installed these tasks needs to
      be done else. Otherwise yast's second stage is started on first
      boot of the migrated image
\item If you want to access any remote filesystem it's a good
      idea to let autoyast add them on first boot of the system
\item Check your network setup in \path{/etc/sysconfig/network}. Is this
      setup still possible in the cloned environment? Make sure you
      check for the MAC address of the card first.
\end{itemize}

\section{Turn my System Into an Image\ldots}
After the process has finished you should check the size of the
image description. The description itself shouldn't be that big.
The size of a migrated image description mainly depends on how many
overlay files exists in the \path{root/} directory. You should make
sure to maintain only required overlay files. Now let's try to create a
clone image from the description. By default an OEM image which is
a virtual disk which is able to run on real hardware too is created.
On success you will also find a ISO file which is an installable
version of the OEM image. If you burn the ISO on a DVD you can use
that DVD to install your cloned image on another computer.

\begin{Command}{8cm}
kiwi -p /tmp/migrated --root /tmp/mySys
kiwi --create /tmp/mySys -d /tmp/myResult
\end{Command}

If everything worked well you can test the created OEM
image in any full virtual operating system environment like QEMU or
VMware. Once created the image description can serve for all image
types KIWI supports.
 
